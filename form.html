<!--  Sign up6 -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Authentication</title>
</head>
<body>
    <div id="homeDiv" style="display: none;">
        <h2>Welcome to the Home Page!</h2>
<button onclick="toggleForms('changePassword')">Change Password</button>
        <button onclick="logout()">Logout</button>
    </div>
    <div id="mainDiv">
        <div id="loginDiv" style="display: block;">
    <header class="headingText" id="div1" tabindex="-1">Login Your Account</header>
            <form target="secret-frame" id="signInForm">
                <label for="loginEmail">Email Address:</label>
                <input type="email" id="loginEmail">

                <label for="loginPassword">Password:</label>
                <input type="password" id="loginPassword">

                <button type="submit" onclick="signIn()">Login</button>
            </form>
            <button onclick="toggleForms('login')">Don't have an account? Sign Up</button>
            <button onclick="toggleForms('forgetPassword')">Forgot Password</button>
        </div>

        <div id="createAccountDiv" style="display: none;">
    <header class="headingText" id="div2" tabindex="-1">Create an Account</header>
            <form target="secret-frame" id="signUpForm">
                <label for="firstName">First Name:</label>
                <input type="text" id="firstName"><br>

                <label for="lastName">Last Name:</label>
                <input type="text" id="lastName"><br>

                <label for="gender">Gender:</label>
                <select id="gender">
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                </select><br>

                <label for="email">Email Address:</label>
                <input type="email" id="email"><br>
                <label for="password">Password:</label>
                <input type="password" id="password"><br>

                <label for="rePassword">Re-enter Password:</label>
                <input type="password" id="rePassword"><br>

                <label>                    <input type="checkbox" id="showPasswordCheckbox">                    Show Password                </label>

        <label for="securityQuestion">Select a security question:</label>
        <select id="securityQuestion" name="securityQuestion">
            <option value="What is your mother's maiden name?">What is your mother's maiden name?</option>
            <option value="What city were you born in?">What city were you born in?</option>
            <option value="What is the name of your first pet?">What is the name of your first pet?</option>
            <option value="What is your favorite movie?">What is your favorite movie?</option>
            <option value="What is the name of your elementary school?">What is the name of your elementary school?</option>
        </select><br>
        <label for="securityAnswer">Your answer:</label>
        <input type="text" id="securityAnswer" name="securityAnswer"><br>

                <button type="submit" onclick="signUp()">Create Account</button>
            </form>
            <button onclick="toggleForms('create')">Have an account? Sign In</button>
        </div>
<div id="changePasswordDiv" style="display: none;">
            <header class="headingText" id="div3" tabindex="-1">Change Password</header>
    <p id="userEmail"></p>
    <label for="oldPassword">Old Password:</label>
    <input type="password" id="oldPassword">
    <label for="newPassword">New Password:</label>
    <input type="password" id="newPassword">
    <label for="reEnterNewPassword">Re-enter New Password:</label>
    <input type="password" id="reEnterNewPassword">
    <button onclick="changePassword()">Submit</button>
</div>
        <div id="forgetPasswordDiv" style="display: none;">
            <header class="headingText" id="div4" tabindex="-1">Forget Password</header>
            <label for="forgetEmail">Enter your registered Email Address:</label>
            <input type="email" id="forgetEmail" disabled>

            <button onclick="verifyAccount()">Verify Account</button>

            <p id="userDetails" style="display: none;"></p>

            <label for="securityAnswer">Security Answer:</label>
            <input type="text" id="securityAnswer" disabled>

            <label for="newPassword">New Password:</label>
            <input type="password" id="newPassword">
            <label for="reEnterNewPassword">Re-enter New Password:</label>
            <input type="password" id="reEnterNewPassword">

            <button onclick="resetPassword()">Reset Password</button>
        </div>
    </div>
            <p id="validationError" aria-live="assertive" aria-atomic="true" role="alert" style="color: red; display: none;"></p>
<iframe name="secret-frame" width="0" height="0" border="0" style="display: none;"></iframe>
    <script>
        function toggleForms(formType) {
            const homeDiv = document.getElementById('homeDiv');
            const mainDiv = document.getElementById('mainDiv');
            const loginDiv = document.getElementById('loginDiv');
            const createAccountDiv = document.getElementById('createAccountDiv');
            const changePasswordDiv = document.getElementById('changePasswordDiv');
            const forgetPasswordDiv = document.getElementById('forgetPasswordDiv');
            if (formType === 'login') {
                loginDiv.style.display = 'none';
                createAccountDiv.style.display = 'block';
                changePasswordDiv.style.display = 'none';
goTo1();
            } else if (formType === 'create') {
                loginDiv.style.display = 'block';
                createAccountDiv.style.display = 'none';
                changePasswordDiv.style.display = 'none';
goTo2();
            } else if (formType === 'changePassword') {
                loginDiv.style.display = 'none';
                createAccountDiv.style.display = 'none';
                homeDiv.style.display = 'none';
                changePasswordDiv.style.display = 'block';
                mainDiv.style.display = 'block';
    const userEmail = JSON.parse(localStorage.getItem('user')).Email;
    document.getElementById('userEmail').textContent = `Email: ${userEmail}`;
goTo3();
            } else if (formType === 'forgetPassword') {
                loginDiv.style.display = 'none';
                forgetPasswordDiv.style.display = 'block';
goTo4();
            }
        }
function goTo1() {   
showMessage('Create an account.', 'blue');
setTimeout(function(){
  document.getElementById("div2").focus();
}, 1000);
}
function goTo2() {   
showMessage('Enter your email address and password.', 'blue');
setTimeout(function(){
  document.getElementById("div1").focus();
}, 1000);
}
function goTo3() {   
showMessage('Enter your current password.', 'blue');
setTimeout(function(){
  document.getElementById("div3").focus();
}, 1000);
}

function signIn() {   
showMessage('Checking your credential, please wait...', 'blue');
login();
}
function signUp() {   
showMessage('Checking your credential, please wait...', 'blue');
checkEmailAvailability();
}
function clearFormFields() {
document.getElementById('signInForm').reset();
document.getElementById('signUpForm').reset();
}
        function showMessage(message, color) {
            const validationError = document.getElementById('validationError');
            validationError.innerText = message;
            validationError.style.color = color;
            validationError.style.display = 'block';
setTimeout(function(){
            validationError.innerText = "";
            validationError.style.display = 'none';
}, 10000);
        }
        async function verifyAccount() {
            const email = document.getElementById('forgetEmail').value;

            const userData = await fetchDataFromDropbox('/user-accounts.txt');

            const user = userData.find(user => user.Email === email);

            if (!user) {
                showMessage('No account found with this email. Please try again.', 'red');
            } else {
                document.getElementById('userDetails').textContent = Name: ${user.FirstName} ${user.LastName};
                document.getElementById('userDetails').style.display = 'block';

                document.getElementById('securityAnswer').disabled = false;
            }
        }

        async function resetPassword() {
            const newPassword = document.getElementById('newPassword').value;
            const reEnterNewPassword = document.getElementById('reEnterNewPassword').value;

            if (newPassword !== reEnterNewPassword) {
                showMessage('New passwords do not match. Please re-enter.', 'red');
                return;
            }

            const email = document.getElementById('forgetEmail').value;

            let userData = await fetchDataFromDropbox('/user-accounts.txt');

            userData = userData.map(user => {
                if (user.Email === email) {
                    user.Password = newPassword;
                }
                return user;
            });

            const updateResponse = await fetch('https://content.dropboxapi.com/2/files/upload', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + dropboxToken,
                    'Content-Type': 'application/octet-stream',
                    'Dropbox-API-Arg': JSON.stringify({
                        path: '/user-accounts.txt',
                        'mode': 'overwrite',
                        autorename: false,
                        mute: false
                    })
                },
                body: JSON.stringify(userData)
            });

            showMessage('Password reset successfully!', 'green');
        }
async function changePassword() {
    const oldPassword = document.getElementById('oldPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const reEnterNewPassword = document.getElementById('reEnterNewPassword').value;

    const user = JSON.parse(localStorage.getItem('user'));
    if (oldPassword !== user.Password) {
        showMessage('Incorrect old password. Please try again.', 'red');
        return;
    }

    if (newPassword !== reEnterNewPassword) {
        showMessage('New passwords do not match. Please re-enter.', 'red');
        return;
    }

    // Update user's password in the local storage
    user.Password = newPassword;
    localStorage.setItem('user', JSON.stringify(user));

    // Fetch user data from Dropbox
    let userData = await fetchDataFromDropbox('/user-accounts.txt');
    // Update user's password in Dropbox data
    userData = userData.map(u => {
        if (u.Email === user.Email) {
            u.Password = newPassword;
        }
        return u;
    });

    // Save updated user data to Dropbox
    const updateResponse = await fetch('https://content.dropboxapi.com/2/files/upload', {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + dropboxToken,
            'Content-Type': 'application/octet-stream',
            'Dropbox-API-Arg': JSON.stringify({
                path: '/user-accounts.txt',
                'mode': 'overwrite',
                autorename: false,
                mute: false
            })
        },
        body: JSON.stringify(userData)
    });

    showMessage('Password changed successfully!', 'green');
    clearFormFields();
}
        async function login() {
            const loginEmail = document.getElementById('loginEmail').value;
            const loginPassword = document.getElementById('loginPassword').value;

            // Fetch user data from Dropbox
            const userData = await fetchDataFromDropbox('/user-accounts.txt');

            const user = userData.find(user => user.Email === loginEmail && user.Password === loginPassword);

            if (user) {
            localStorage.setItem('user', JSON.stringify(user)); // Save user data to localStorage
            document.getElementById('mainDiv').style.display = 'none';
            document.getElementById('homeDiv').style.display = 'block';
showMessage(`Login successful! Welcome, ${user.FirstName} ${user.LastName}!`, 'green');
clearFormFields();
            } else {
                showMessage('Invalid email or password. Please try again.', 'red');
            }
        }
async function checkEmailAvailability() {
    const email = document.getElementById('email').value;

    const userData = await fetchDataFromDropbox('/user-accounts.txt');

    const emailExists = userData.some(user => user.Email === email);

    if (emailExists) {
        showMessage('Your account is already created. Please login with your email address and password.', 'blue');
    } else {
                validateAndSubmit();
            }
        }

        async function createAccount() {
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const gender = document.getElementById('gender').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const rePassword = document.getElementById('rePassword').value;
            const securityQuestion = document.getElementById('securityQuestion').value;
            const securityAnswer = document.getElementById('securityAnswer').value;

            if (password !== rePassword) {
                showMessage('Passwords do not match. Please re-enter.', 'red');
return;
            }

    let userData = await fetchDataFromDropbox('/user-accounts.txt');

    userData.push({
        FirstName: firstName,
        LastName: lastName,
        Gender: gender,
        Email: email,
        Password: password,
        SecurityQuestion: securityQuestion,
        SecurityAnswer: securityAnswer
    });

            // Save updated user data to Dropbox
            const updatedResponse = await fetch('https://content.dropboxapi.com/2/files/upload', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + dropboxToken,
                    'Content-Type': 'application/octet-stream',
                    'Dropbox-API-Arg': JSON.stringify({
                        path: '/user-accounts.txt',
                        'mode': 'overwrite',
                        autorename: false,
                        mute: false
                    })
                },
                body: JSON.stringify(userData)
            });

            showMessage('Account created successfully!', 'green');
clearFormFields();
        }
function generateToken(refreshToken, clientId, clientSecret) {
const url = 'https://api.dropbox.com/oauth2/token';
const data = `grant_type=refresh_token&refresh_token=${refreshToken}&client_id=${clientId}&client_secret=${clientSecret}`;
return fetch(url, {
method: 'POST',
headers: {
'Content-Type': 'application/x-www-form-urlencoded'
},
body: data
})
.then((response) => {
if (!response.ok) {
throw new Error('Failed to get access token: ' + response.statusText);
}
return response.json();
})
.then((responseData) => {
return responseData.access_token;
})
.catch((error) => {
throw new Error('Error generating access token: ' + error.message);
});
}
function checkToken() {
let localToken = JSON.parse(localStorage.getItem("localToken"));
if (localToken && localToken.expire > new Date().getTime()) {
dropboxToken = localToken.token;
} else {
generateToken('AALu1gsBgjcAAAAAAAAAATLeuJoxd86bwIAnmd9KoDsWC4lRU_SruT9ZUVrfr8hz', '7u6mvcyvv6szugw', 'gka5o3baeaw2lin')
.then((token) => {
dropboxToken = token;
var storeToken = { token: token, expire: new Date().getTime() + (3*60*60*1000)};
localStorage.setItem("localToken", JSON.stringify(storeToken));
})
.catch((error) => {
showMessage(error.message, 'red');
});
}
}
function validateAndSubmit() {
showMessage('Creating account, please wait...', 'green');
createAccount();
}
        // Function to handle user logout
        function logout() {
            localStorage.removeItem('user'); // Clear user data from localStorage
            document.getElementById('mainDiv').style.display = 'block';
            document.getElementById('homeDiv').style.display = 'none';
        }

        // Check user login session on page load
        window.onload = function() {
            const user = JSON.parse(localStorage.getItem('user'));
            if (user) {
                document.getElementById('mainDiv').style.display = 'none';
                document.getElementById('homeDiv').style.display = 'block';
            } else {
                document.getElementById('mainDiv').style.display = 'block';
                document.getElementById('homeDiv').style.display = 'none';
            }
        }
// Common function to fetch data from Dropbox
async function fetchDataFromDropbox(path) {
    const response = await fetch('https://content.dropboxapi.com/2/files/download', {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + dropboxToken,
            'Dropbox-API-Arg': JSON.stringify({
                path: path
            })
        }
    });
    return await response.json();
}

window.addEventListener("load", checkToken);
    </script>
</body>
</html>
