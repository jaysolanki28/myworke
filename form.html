<div id="verifyAccountDiv" style="display: block;">
    <h2>Verify Account</h2>
    <label for="forgotEmail">Enter your registered email:</label>
    <input type="email" id="forgotEmail">
    <button onclick="verifyAccount()">Verify Account</button>
</div>

<div id="verifySecurityAnswerDiv" style="display: none;">
    <h2>Verify Security Answer</h2>
    <p id="securityQuestion"></p>
    <label for="securityAnswerInput">Your answer:</label>
    <input type="text" id="securityAnswerInput">
    <button onclick="verifySecurityAnswer()">Verify Answer</button>
</div>

<div id="setNewPasswordDiv" style="display: none;">
    <h2>Set New Password</h2>
    <label for="newPasswordInput">New Password:</label>
    <input type="password" id="newPasswordInput">
    <label for="reenterNewPasswordInput">Re-enter New Password:</label>
    <input type="password" id="reenterNewPasswordInput">
    <button onclick="setNewPassword()">Set Password</button>
</div>
<script>


async function verifyAccount() {
    const email = document.getElementById('forgotEmail').value;
    const userData = await fetchDataFromDropbox('/user-accounts.txt');
    const user = userData.find(user => user.Email === email);

    if (user) {
        document.getElementById('verifyAccountDiv').style.display = 'none';
        document.getElementById('verifySecurityAnswerDiv').style.display = 'block';
        document.getElementById('securityQuestion').textContent = user.SecurityQuestion;
    } else {
        showMessage('No account found with this email. Please try again.', 'red');
    }
}

async function verifySecurityAnswer() {
    const securityAnswer = document.getElementById('securityAnswerInput').value;
    const userData = await fetchDataFromDropbox('/user-accounts.txt');
    const user = userData.find(user => user.Email === email);

    if (securityAnswer === user.SecurityAnswer) {
        document.getElementById('verifySecurityAnswerDiv').style.display = 'none';
        document.getElementById('setNewPasswordDiv').style.display = 'block';
    } else {
        showMessage('Incorrect security answer. Please try again.', 'red');
    }
}

async function setNewPassword() {
    const newPassword = document.getElementById('newPasswordInput').value;
    const reenteredPassword = document.getElementById('reenterNewPasswordInput').value;
    
    if (newPassword !== reenteredPassword) {
        showMessage('New passwords do not match. Please re-enter.', 'red');
        return;
    }

    const userData = await fetchDataFromDropbox('/user-accounts.txt');
    const user = userData.find(user => user.Email === email);

    user.Password = newPassword;

    // Update user's password in the Dropbox data
    userData = userData.map(u => {
        if (u.Email === user.Email) {
            u.Password = newPassword;
        }
        return u;
    });

    // Save updated user data to Dropbox
    const updateResponse = await fetch('https://content.dropboxapi.com/2/files/upload', {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + dropboxToken,
            'Content-Type': 'application/json',
            'Dropbox-API-Arg': JSON.stringify({
                path: '/user-accounts.txt',
                'mode': 'overwrite'
            })
        },
        body: JSON.stringify(userData)
    });

    showMessage('Password changed successfully!', 'green');
}
async function fetchDataFromDropbox(path) {
    const response = await fetch('https://content.dropboxapi.com/2/files/download', {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + dropboxToken,
            'Dropbox-API-Arg': JSON.stringify({
                path: path
            })
        }
    });
    return await response.json();
}
function generateToken(refreshToken, clientId, clientSecret) {
const url = 'https://api.dropbox.com/oauth2/token';
const data = `grant_type=refresh_token&refresh_token=${refreshToken}&client_id=${clientId}&client_secret=${clientSecret}`;
return fetch(url, {
method: 'POST',
headers: {
'Content-Type': 'application/x-www-form-urlencoded'
},
body: data
})
.then((response) => {
if (!response.ok) {
throw new Error('Failed to get access token: ' + response.statusText);
}
return response.json();
})
.then((responseData) => {
return responseData.access_token;
})
.catch((error) => {
throw new Error('Error generating access token: ' + error.message);
});
}
function checkToken() {
let localToken = JSON.parse(localStorage.getItem("localToken"));
if (localToken && localToken.expire > new Date().getTime()) {
dropboxToken = localToken.token;
} else {
generateToken('AALu1gsBgjcAAAAAAAAAATLeuJoxd86bwIAnmd9KoDsWC4lRU_SruT9ZUVrfr8hz', '7u6mvcyvv6szugw', 'gka5o3baeaw2lin')
.then((token) => {
dropboxToken = token;
var storeToken = { token: token, expire: new Date().getTime() + (3*60*60*1000)};
localStorage.setItem("localToken", JSON.stringify(storeToken));
})
.catch((error) => {
showMessage(error.message, 'red');
});
}
}
window.addEventListener("load", checkToken);
</script>