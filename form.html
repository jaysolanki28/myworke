<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Accounts</title>
    <link rel="stylesheet" href="styles.css">

<style>
.user {
    margin-bottom: 10px;
}

.user button {
    margin-right: 10px;
}

.user-data {
    margin-top: 5px;
    padding: 10px;
    border: 1px solid #ccc;
    background-color: #f9f9f9;
}

.user-data p {
    margin: 5px 0;
}
</style>
</head>
<body>
    <div id="userList"></div>

    <script>
document.addEventListener('DOMContentLoaded', async function() {
    const userData = await fetchDataFromDropbox('/user-accounts.txt');
    renderUserList(userData);
});

async function fetchDataFromDropbox(path) {
    const response = await fetch('https://content.dropboxapi.com/2/files/download', {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + dropboxToken,
            'Dropbox-API-Arg': JSON.stringify({
                path: path
            })
        }
    });
    return await response.json();
}

function renderUserList(userData) {
    const userListDiv = document.getElementById('userList');

    userData.forEach(user => {
        const userDiv = document.createElement('div');
        userDiv.classList.add('user');

        const button = document.createElement('button');
        button.textContent = `${user.FirstName} ${user.LastName}`;
        button.addEventListener('click', () => {
            toggleUserData(userDiv);
        });

        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'Delete User';
        deleteButton.addEventListener('click', () => {
            const confirmDelete = confirm(Are you sure you want to delete ${user.FirstName} ${user.LastName}?);
            if (confirmDelete) {
                deleteUser(user);
                userDiv.remove();
                showMessage('Please wait...', 'blue');
            } else {
                showMessage('User deletion cancelled.', 'blue');
            }
        });

        const userDataDiv = document.createElement('div');
        userDataDiv.classList.add('user-data');
        userDataDiv.style.display = 'none'; // Initially hide user data

        const userDataDetails = 
            <p><strong>Name:</strong> ${user.FirstName} ${user.LastName}</p>
            <p><strong>Gender:</strong> ${user.Gender}</p>
            <p><strong>Email:</strong> ${user.Email}</p>
        ;

        userDataDiv.innerHTML = userDataDetails;

        userDiv.appendChild(button);
        userDiv.appendChild(userDataDiv);
        userDiv.appendChild(deleteButton);

        userListDiv.appendChild(userDiv);
    });
}

function toggleUserData(userDiv) {
    const userDataDiv = userDiv.querySelector('.user-data');
    userDataDiv.style.display = userDataDiv.style.display === 'none' ? 'block' : 'none';
}

async function deleteUser(user) {
    let userData = await fetchDataFromDropbox('/user-accounts.txt');
    userData = userData.filter(u => u.Email !== user.Email);

    const response = await fetch('https://content.dropboxapi.com/2/files/upload', {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + dropboxToken,
            'Content-Type': 'application/octet-stream',
            'Dropbox-API-Arg': JSON.stringify({
                path: '/user-accounts.txt',
                'mode': 'overwrite',
                autorename: false,
                mute: false
            })
        },
        body: JSON.stringify(userData)
    });

    if (response.ok) {
        showMessage('User deleted successfully!', 'green');
    } else {
        showMessage('Failed to delete user.', 'red');
    }
}
function generateToken(refreshToken, clientId, clientSecret) {
const url = 'https://api.dropbox.com/oauth2/token';
const data = `grant_type=refresh_token&refresh_token=${refreshToken}&client_id=${clientId}&client_secret=${clientSecret}`;
return fetch(url, {
method: 'POST',
headers: {
'Content-Type': 'application/x-www-form-urlencoded'
},
body: data
})
.then((response) => {
if (!response.ok) {
throw new Error('Failed to get access token: ' + response.statusText);
}
return response.json();
})
.then((responseData) => {
return responseData.access_token;
})
.catch((error) => {
throw new Error('Error generating access token: ' + error.message);
});
}
function checkToken() {
let localToken = JSON.parse(localStorage.getItem("localToken"));
if (localToken && localToken.expire > new Date().getTime()) {
dropboxToken = localToken.token;
} else {
generateToken('AALu1gsBgjcAAAAAAAAAATLeuJoxd86bwIAnmd9KoDsWC4lRU_SruT9ZUVrfr8hz', '7u6mvcyvv6szugw', 'gka5o3baeaw2lin')
.then((token) => {
dropboxToken = token;
var storeToken = { token: token, expire: new Date().getTime() + (3*60*60*1000)};
localStorage.setItem("localToken", JSON.stringify(storeToken));
})
.catch((error) => {
showMessage(error.message, 'red');
});
}
}

function showMessage(message, color) {
    const validationError = document.getElementById('validationError');
    validationError.innerText = message;
    validationError.style.color = color;
    validationError.style.display = 'block';
    setTimeout(function(){
        validationError.innerText = "";
        validationError.style.display = 'none';
    }, 5000);
}
</script>
</body>
</html>