<!--  Sign up11 -->
<!DOCTYPE html>
<html lang="en">
<head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="HandheldFriendly" content="true">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<style>
/* styling for form */
    .form-container {
        max-width: 70%; /* Set maximum width for the forms */
        padding: 20px;
        border: 8px solid #fff;
        border-radius: 5px;
        background-color: #550000;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
.headingText {
color: #87CEEB;font-weight: bold;        font-size: 14px;    text-align: center;    margin-top: 5px;    margin-bottom: 8px;}label {
        margin-bottom: 2px;
color: #fff;
font-size: 10px;
    }

input, select {
   height: 30px; width: 100%;    color: #fff; background-color: #000:    padding: 10px;    margin-bottom: 10px;    border: 3px solid #8B8000;    border-radius: 5px;    box-sizing: border-box;}
.continue-button {
    width: 100%; height: 50px;            font-size: 20px;font-weight: bold;    background-color: green;    color: #000;    padding: 10px 20px;    border: 8px solid #E6F7FF;    border-radius: 20px;    cursor: pointer; }
#login {
    width: 100%; height: 50px;            font-size: 20px;font-weight: bold;    background-color: #007bff;    color: #000;    padding: 10px 20px;    border: 8px solid #E6F7FF;    border-radius: 20px;    cursor: pointer; }
.forget {
    width: 100%; height: 50px;            font-size: 20px;font-weight: bold;    background-color: yellow;    color: #000;    padding: 10px 20px;    border: 8px solid #E6F7FF;    border-radius: 20px;    cursor: pointer; }
.toggle {
    width: 100%; height: 50px;            font-size: 20px;font-weight: bold;    background-color: green;    color: #000;    padding: 10px 20px;    border: 8px solid #E6F7FF;    border-radius: 20px;    cursor: pointer; }
#alertBox {
    height: 50px;    position: fixed;    bottom: 3%;    width: 100%;    background-color: #fff;    opacity: 1;   ;    font-size: 12px;    text-align: center;    display: none;}
/* styling for home page */
html, body {
        display: flex;        justify-content: center;        align-items: center; padding: 0; margin: 0; width: 100%; height: 100%; font-family: Arial;background-color: #808080; webkit-user-select: none;       -webkit-touch-callout: none;       -moz-user-select: none;       -ms-user-select: none;       user-select: none; }
.box {
position: fixed;     top: 30%;    float: left;margin-left: 9vw; height: auto; width: 80vw; border-radius: 10px; border: 10px solid #550000;   }
.buttons {
    width: 250px;    height: 50px;    line-height: 50px;    text-align: center;    background-color: #550000;    color: #fff;    border: 2px solid #ffd700;    margin: 50px auto;border-radius: 25px; }
.c {
visibility: hidden; }
.header {
  background-color: #550000;
  color: #ffd700;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 20px;
}

.welcome-text {
  font-size: 20px;
font-weight: bold;    
}

.header-btn {
  background-color: #550000;
  color: #fff;
  border: none;
/*  padding: 8px 16px;*/
  border-radius: 4px;
  cursor: pointer;
}
    select option:first-child {
        display: none;
    }
</style>
    <title>Log in Your Account</title>
</head>
<body>
    <div id="homeDiv" style="display: none;">
<div class="header">
  <div class="welcome-text" aria-live="polite">Saint Joseph's Academy</div>
  <button class="header-btn" onclick="showDropdown('target1')" aria-label="More options"><i class="fas fa-ellipsis-v"></i></button>
</div>
<div class="box" align="center">
<div class="buttons" onclick="window.location.href='go:studyroom'">Study Room</div>
<div class="buttons" onclick="window.location.href='http://action_notifications'">Notifications</div>
                <select aria-hidden="true" onchange="dropDown1()" id="target1" class="c" name="name_of_selectt "> 
<option disabled selected value=""></option> 
<option value="">Enrollment Form</option> 
<option value="">Contact Us</option>
<option value="">Social Media</option>
<option value="">Share App</option>
<option value="">Change Password</option> 
<option value="">Logout</option> 
<option value="">Administration Area</option> 
</select>
                <select aria-hidden="true" onchange="dropDown2()" id="target2" class="c" name="name_of_selectt ">
<option disabled selected value=""></option> 
<option value="">Mail Us</option>  
<option value="">WhatsApp Us</option>
<option value="">Call Us</option>
</select>
                <select aria-hidden="true" onchange="dropDown3()" id="target3" class="c" name="name_of_selectt ">
<option  disabled selected value=""></option> 
<option value="">Telegram Channel</option>  
<option value="">WhatsApp Channel</option>  
</select>
</div>
    </div>
    <div id="mainDiv" class="form-container">
        <div id="loginDiv" style="display: block;">
    <header class="headingText" id="div1" tabindex="-1">Log in Your Account</header>
            <form target="secret-frame" id="signInForm">
                <label for="loginEmail">Email Address:</label>
                <input type="email" id="loginEmail">

                <label for="loginPassword">Password:</label>
                <input type="password" id="loginPassword"><br><br>

                <button type="submit" id="login" onclick="signIn()">Login</button><br><br>
            </form>
            <button class="toggle" onclick="toggleForms('login')">Don't have an account? Sign Up</button><br>
            <button class="forget" onclick="toggleForms('forgetPassword')">Forgot Password? Reset</button>
        </div>

        <div id="createAccountDiv" style="display: none;">
    <header class="headingText" id="div2" tabindex="-1">Create an Account</header>
            <form target="secret-frame" id="signUpForm">
                <label for="firstName">First Name:</label>
                <input type="text" id="firstName"><br>

                <label for="lastName">Last Name:</label>
                <input type="text" id="lastName"><br>

                <label for="gender">Gender:</label>
                <select id="gender">
                    <option value="">Select Gender</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="Transgender">Transgender</option>
                </select><br>

                <label for="email">Email Address:</label>
                <input type="email" id="email"><br>
                <label for="password">Password:</label>
                <input type="password" id="password"><br>

                <label for="rePassword">Re-enter Password:</label>
                <input type="password" id="rePassword"><br>

                <label>                    <input type="checkbox" id="showPasswordCheckbox">                    Show Password                </label><br>

<div id="otpDiv" style="display: none;">
        <input type="tel" id="otpInput" placeholder="Enter OTP"><br>
<span id="signupOtpExpiryTimer"></span><br>
        <button type="button" class="continue" id="validateOTPButton" onclick="validateOTP()">Create Account</button>
</div>
                <button type="button" class="sendOtp" id="sendOtpButton" onclick="signUp()">Send OTP</button>
            </form><br>
            <button class="toggle" onclick="toggleForms('create')">Have an account? Sign In</button>
        </div>
<div id="changePasswordDiv" style="display: none;">
            <header class="headingText" id="div3" tabindex="-1">Change Your Account Password</header>
            <form target="secret-frame" id="changePasswordForm">
    <label for="oldPassword">Current Password:</label>
    <input type="password" id="oldPassword">
    <label for="newPassword">New Password:</label>
    <input type="password" id="newPassword">
    <label for="reEnterNewPassword">Re-enter New Password:</label>
    <input type="password" id="reEnterNewPassword"><br><br>
    <button class="continue" onclick="changePassword1()">Change Password</button>
</form>
</div>
        <div id="forgetPasswordDiv" style="display: none;">
            <header class="headingText" id="div4" tabindex="-1">Forget Your Account Password</header>
            <form target="secret-frame" id="forgetPasswordForm">
<div id="verifyAccountDiv" style="display: block;">

    <label for="forgotEmail">Enter your registered email:</label>
    <input type="email" id="forgotEmail"><br>
    <button class="forget" id="verifyAccount" onclick="forgetPassword1()">Verify Account</button>
</div>

<div id="resetOtpDiv" style="display: none;">
    <label for="">Enter OTP:</label>
        <input type="tel" id="resetOtpInput" placeholder="Enter OTP"><br>
<span id="otpExpiryTimer"></span><br>
        <button type="button" class="forget" id="validateResetOTP" onclick="forgetPassword2()">Validate OTP</button>
</div>
<div id="setNewPasswordDiv" style="display: none;">
    <label for="newPasswordInput">New Password:</label>
    <input type="password" id="newPasswordInput">
    <label for="reenterNewPasswordInput">Re-enter New Password:</label>
    <input type="password" id="reenterNewPasswordInput"><br><br>
<button class="forget" onclick="forgetPassword3()">Reset Password</button>
</div>
</form>
        </div>
    </div>
<iframe name="secret-frame" width="0" height="0" border="0" style="display: none;"></iframe>
<div id="alertBox">
            <p id="validationError" aria-live="assertive" role="alert"></p>
</div>
    <script>
        function toggleForms(formType) {
            const homeDiv = document.getElementById('homeDiv');
            const mainDiv = document.getElementById('mainDiv');
            const loginDiv = document.getElementById('loginDiv');
            const createAccountDiv = document.getElementById('createAccountDiv');
            const forgetPasswordDiv = document.getElementById('forgetPasswordDiv');
            if (formType === 'login') {
                loginDiv.style.display = 'none';
                createAccountDiv.style.display = 'block';
document.title = "Create An Account";
            } else if (formType === 'create') {
                loginDiv.style.display = 'block';
                createAccountDiv.style.display = 'none';
document.title = "Log in Your Account";
            } else if (formType === 'forgetPassword') {
                loginDiv.style.display = 'none';
                forgetPasswordDiv.style.display = 'block';
document.title = "Forget Your Account Password";
            }
        }
function signIn() {   
showMessage('Checking your credential, please wait...', 'blue');
login();
}
function signUp() {   
showMessage('Checking your credential, please wait...', 'blue');
 checkEmailAvailability();
}
function changePassword1() {   
showMessage('Checking your credential, please wait...', 'blue');
changePassword();
}
function sendOtp1() {   
showMessage('Sending OTP, please wait...', 'blue');
sendOtp();
}
function clearFormFields() {
document.getElementById('signInForm').reset();
document.getElementById('signUpForm').reset();
document.getElementById('changePasswordForm').reset();
document.getElementById('forgetPasswordForm').reset();
}
        function showMessage(message, color) {
            const alertBox = document.getElementById('alertBox');
            const validationError = document.getElementById('validationError');
            validationError.innerText = message;
            validationError.style.color = color;
            alertBox.style.display = 'block';
setTimeout(function(){
            validationError.innerText = "";
alertBox.style.display = 'none';
}, 15000);
        }
async function changePassword() {
    const oldPassword = document.getElementById('oldPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const reEnterNewPassword = document.getElementById('reEnterNewPassword').value;
    if (!oldPassword) {
        showMessage('Please enter your current password.', 'red');
        return;
    }
    if (!newPassword) {
        showMessage('Please enter new password.', 'red');
        return;
    }
    if (!reEnterNewPassword) {
        showMessage('Please re enter new password.', 'red');
        return;
    }

    const user = JSON.parse(localStorage.getItem('user'));
    if (oldPassword !== user.Password) {
        showMessage('Incorrect current password. Please try again.', 'red');
        return;
    }

    if (newPassword !== reEnterNewPassword) {
        showMessage('New passwords do not match. Please re-enter.', 'red');
        return;
    }

    // Update user's password in the local storage
    user.Password = newPassword;
    localStorage.setItem('user', JSON.stringify(user));

    // Fetch user data from Dropbox
    let userData = await fetchDataFromDropbox('/user-accounts.txt');
    // Update user's password in Dropbox data
    userData = userData.map(u => {
        if (u.Email === user.Email) {
            u.Password = newPassword;
        }
        return u;
    });

    // Save updated user data to Dropbox
    const updateResponse = await fetch('https://content.dropboxapi.com/2/files/upload', {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + dropboxToken,
            'Content-Type': 'application/octet-stream',
            'Dropbox-API-Arg': JSON.stringify({
                path: '/user-accounts.txt',
                'mode': 'overwrite',
                autorename: false,
                mute: false
            })
        },
        body: JSON.stringify(userData)
    });
    clearFormFields();
            document.getElementById('mainDiv').style.display = 'none';
            document.getElementById('homeDiv').style.display = 'block';
document.title = "Saint Joseph's Academy";
    showMessage('Password changed successfully!', 'green');
}
        async function login() {
            const loginEmail = document.getElementById('loginEmail').value;
            const loginPassword = document.getElementById('loginPassword').value;
    if (!loginEmail) {
        showMessage('Please enter log in email address.', 'red');
        return;
    }
    if (!loginPassword) {
        showMessage('Please enter log in password.', 'red');
        return;
    }

    // Fetch user data from Dropbox
    let userData = await fetchDataFromDropbox('/user-accounts.txt');

    const userIndex = userData.findIndex(user => user.Email === loginEmail && user.Password === loginPassword);

    if (userIndex !== -1) {
        const user = userData[userIndex];
        if (user.LoginStatus === '0') {
            // Update loginStatus to '1' in user data
            userData[userIndex].LoginStatus = '1';
            // Update user data in Dropbox
            await updateUserDataInDropbox(userData);
            // Proceed with login
            document.getElementById('mainDiv').style.display = 'none';
            document.getElementById('homeDiv').style.display = 'block';
            document.title = "Saint Joseph's Academy";
            localStorage.setItem('user', JSON.stringify(user)); // Save user data to localStorage
            clearFormFields();
            showMessage(`Login successful! Welcome, ${user.FirstName} ${user.LastName}!`, 'green');
        } else {
            showMessage('You are already logged in on another device.', 'red');
        }
    } else {
        showMessage('Invalid email or password. Please double check your credentials and try again.', 'red');
    }
}
async function checkEmailAvailability() {
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const gender = document.getElementById('gender').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const rePassword = document.getElementById('rePassword').value;
    if (!firstName) {
        showMessage('Please enter your first name.', 'red');
        return;
    }
    if (!lastName) {
        showMessage('Please enter your last name.', 'red');
        return;
    }
    if (!gender) {
        showMessage('Please select your gender.', 'red');
        return;
    }
    if (!email) {
        showMessage('Please enter your email address.', 'red');
        return;
    }
    if (!password) {
        showMessage('Please enter password.', 'red');
        return;
    }
            if (password !== rePassword) {
                showMessage('Passwords do not match. Please re-enter.', 'red');
return;
            }

    const userData = await fetchDataFromDropbox('/user-accounts.txt');

    const emailExists = userData.some(user => user.Email === email);

    if (emailExists) {
        showMessage('Your account is already registered. Please log in using your email address and password.', 'blue');
    } else {
                sendOtp1();
            }
        }
        function sendOtp() {
            const apiKey = '6F9D8F439B6A4A0D958C88B7E6DE705BF0069E776648E148DACC963CD99EDE006278F85631F95A45C43B306F465C5590';
            const senderEmail = 'jaysolanki060192@gmail.com';
            const recipientEmail = document.getElementById('email').value;
            const otp = Math.floor(100000 + Math.random() * 900000);
            const subject = 'One Time Password (OTP) for Account Verification';
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const body = `<h1>Dear ${firstName} ${lastName},</h1>
<p>Thank you for initiating an account verification. Your One-Time Password (OTP) is:</p>
<b>${otp}</b>
<p>Please enter this OTP in the designated field to complete your verification.</p>
<p>This OTP will expire in 3 minutes. If you do not receive the OTP or it expires, please contact our support team.</p>
<p>If you did not request a sign-up, please ignore this email.</p>
<h2>Important Notes:</h2>
<p>For security reasons, please do not share this OTP with anyone. Keep it confidential and use it only for the purpose of account verification.</p>
<p>And do not click on the unsubscribe link below. Doing so may cause problems in recovering your account in the future.</p>
<p>Thank you for your cooperation.</p>
<p>Sincerely,<br>
Saint Joseph's Academy</p>`;

            const data = new URLSearchParams();
            data.append('apiKey', apiKey);
            data.append('subject', subject);
            data.append('from', senderEmail);
            data.append('to', recipientEmail);
            data.append('bodyHtml', body); // Use bodyHtml to send HTML content

            fetch('https://api.elasticemail.com/v2/email/send', {
                method: 'POST',
                body: data
            })
            .then(response => response.json())
            .then(data => {
document.getElementById('firstName').disabled = true;
document.getElementById('lastName').disabled = true;
document.getElementById('gender').disabled = true;
document.getElementById('email').disabled = true;
document.getElementById('password').disabled = true;
document.getElementById('rePassword').disabled = true;
        document.getElementById('sendOtpButton').style.display = 'none';
        document.getElementById('otpDiv').style.display = 'block';
        document.getElementById("otpInput").focus();
        localStorage.setItem('otp', otp);
startSignupOtpExpiryTimer();
        showMessage('OTP sent successfully! check your mailbox.', 'green');
                console.log(JSON.stringify(data)); // stringify the response object
            })
            .catch(error => {
        showMessage('Error sending OTP. Please try again.', 'red');
                console.error(error);
            });
        }
let timerInterval; // Define timerInterval globally

function startSignupOtpExpiryTimer() {
    const signupExpiryTime = new Date().getTime() + 3 * 60 * 1000; // 3 minutes expiry
    localStorage.setItem('signupOtpExpiry', signupExpiryTime); // Store OTP signupExpiry time

    // Update the remaining time every second
    timerInterval = setInterval(function () {
        const currentTime = new Date().getTime();
        const remainingTime = parseInt(localStorage.getItem('signupOtpExpiry')) - currentTime;

        if (remainingTime <= 0) {
            clearInterval(timerInterval); // Stop the timer when OTP expires
            localStorage.removeItem('otp'); // Remove OTP from local storage
            localStorage.removeItem('signupOtpExpiry'); // Remove OTP expiry time from local storage
            document.getElementById('signupOtpExpiryTimer').innerText = 'OTP Expired'; // Update HTML to show OTP expired
        showMessage('OTP expired.', 'red');
            return;
        }

        // Display remaining time in HTML
        const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);
        document.getElementById('signupOtpExpiryTimer').innerText = `${minutes}m ${seconds}s`; // Fixed this line
    }, 1000);
}

function validateOTP() {
    const enteredOTP = document.getElementById('otpInput').value;
    const storedOTP = localStorage.getItem('otp');

    if (enteredOTP === storedOTP) {
        localStorage.removeItem('otp');
        localStorage.removeItem('signupOtpExpiry');
        document.getElementById('signupOtpExpiryTimer').style.display = 'none';
    clearInterval(timerInterval); // Clear the timer interval

validateAndSubmit();

    } else {
        showMessage('Invalid OTP. Please try again.', 'red');
    }
}
        async function createAccount() {
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const gender = document.getElementById('gender').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
const loginStatus = '0';
    let userData = await fetchDataFromDropbox('/user-accounts.txt');

    userData.push({
        FirstName: firstName,
        LastName: lastName,
        Gender: gender,
        Email: email,
        Password: password,
 LoginStatus:  loginStatus
    });

            // Save updated user data to Dropbox
            const updatedResponse = await fetch('https://content.dropboxapi.com/2/files/upload', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + dropboxToken,
                    'Content-Type': 'application/octet-stream',
                    'Dropbox-API-Arg': JSON.stringify({
                        path: '/user-accounts.txt',
                        'mode': 'overwrite',
                        autorename: false,
                        mute: false
                    })
                },
                body: JSON.stringify(userData)
            });

        document.getElementById('createAccountDiv').style.display = 'none';
        document.getElementById('loginDiv').style.display = 'block';
document.title = "Log in Your Account";
clearFormFields();
            showMessage('Account created successfully! now log in your new account.', 'green');
        }
function forgetPassword1() {   
showMessage('Checking your credential, please wait...', 'blue');
verifyAccount();
}
function forgetPassword2() {   
showMessage('Checking your credential, please wait...', 'blue');
validateResetOTP();
}
function forgetPassword3() {   
showMessage('Checking your credential, please wait...', 'blue');
setNewPassword();
}
let timeInterval; // Define timerInterval globally

async function verifyAccount() {
    const email = document.getElementById('forgotEmail').value.trim(); // Trim email to remove leading/trailing spaces
    if (!email) {
        showMessage('Please enter your email address.', 'red');
        return;
    }
    const userData = await fetchDataFromDropbox('/user-accounts.txt');
    const user = userData.find(user => user.Email === email);

    if (user) {
        showMessage('Sending OTP, please wait...', 'blue');
        sendResetOtp();
    } else {
        showMessage('No account found with this email. Please try again.', 'red');
    }
}

function sendResetOtp() {
    const apiKey = '6F9D8F439B6A4A0D958C88B7E6DE705BF0069E776648E148DACC963CD99EDE006278F85631F95A45C43B306F465C5590';
    const senderEmail = 'jaysolanki060192@gmail.com';
    const recipientEmail = document.getElementById('forgotEmail').value.trim(); // Trim email
    const resetotp = Math.floor(100000 + Math.random() * 900000);
    const subject = "Password Reset Request for Saint Joseph's Academy";
    const body = `<h1>Dear user</h1>
                  <p>We received a request to reset your password for your Saint Joseph's Academy account. To complete the process, please enter the following One-Time Password (OTP) in the app:</p>
                  <b>${resetotp}</b>
                  <p>This OTP will expire in 3 minutes. If you do not receive the OTP or it expires, please contact our support team.</p>
                  <p>If you did not request a password reset, please ignore this email.</p>
                  <h2>Important Notes:</h2>
                  <p>For security reasons, please do not share this OTP with anyone. Keep it confidential and use it only for the purpose of account verification.</p>
                  <p>And do not click on the unsubscribe link below. Doing so may cause problems in recovering your account in the future.</p>
                  <p>Thank you for your cooperation.</p>
                  <p>Sincerely,<br>Saint Joseph's Academy</p>`;

    const data = new URLSearchParams();
    data.append('apiKey', apiKey);
    data.append('subject', subject);
    data.append('from', senderEmail);
    data.append('to', recipientEmail);
    data.append('bodyHtml', body);

    fetch('https://api.elasticemail.com/v2/email/send', {
        method: 'POST',
        body: data
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('resetOtpDiv').style.display = 'block';
        document.getElementById("resetOtpInput").focus();
        document.getElementById('forgotEmail').disabled = true;
        document.getElementById('verifyAccount').disabled = true;
        localStorage.setItem('resetotp', resetotp);
        startOtpExpiryTimer(); // Start the timer for OTP expiry
        showMessage('OTP sent successfully! check your mailbox.', 'green');
        console.log(JSON.stringify(data)); // stringify the response object
    })
    .catch(error => {
        showMessage('Error sending OTP. Please try again.', 'red');
        console.error(error);
    });
}

function startOtpExpiryTimer() {
    const expiryTime = new Date().getTime() + 3 * 60 * 1000; // 3 minutes expiry
    localStorage.setItem('otpExpiry', expiryTime); // Store OTP expiry time

    // Update the remaining time every second
    timeInterval = setInterval(function () {
        const currentTime = new Date().getTime();
        const remainingTime = parseInt(localStorage.getItem('otpExpiry')) - currentTime;

        if (remainingTime <= 0) {
            clearInterval(timeInterval); // Stop the timer when OTP expires
            localStorage.removeItem('resetotp'); // Remove OTP from local storage
            localStorage.removeItem('otpExpiry'); // Remove OTP expiry time from local storage
            document.getElementById('otpExpiryTimer').innerText = 'Expired'; // Update HTML to show OTP expired
            return;
        }

        // Display remaining time in HTML
        const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);
        document.getElementById('otpExpiryTimer').innerText = `${minutes}m ${seconds}s`;
    }, 1000);
}

function validateResetOTP() {
    const enteredResetOTP = document.getElementById('resetOtpInput').value;
    const storedResetOTP = localStorage.getItem('resetotp');

    if (enteredResetOTP === storedResetOTP) {
        localStorage.removeItem('resetotp');
        document.getElementById('resetOtpInput').disabled = true;
        document.getElementById('validateResetOTP').disabled = true;
        document.getElementById('setNewPasswordDiv').style.display = 'block';
        document.getElementById("newPasswordInput").focus();
        clearInterval(timeInterval); // Clear the timer
        localStorage.removeItem('otpExpiry');
        document.getElementById('otpExpiryTimer').style.display = 'none';
    } else {
        showMessage('Invalid OTP. Please try again.', 'red');
    }
}

async function setNewPassword() {
    const newPassword = document.getElementById('newPasswordInput').value;
    const reenteredPassword = document.getElementById('reenterNewPasswordInput').value;
    const email = document.getElementById('forgotEmail').value; // Define email variable here

    if (!newPassword) {
        showMessage('Please enter new password.', 'red');
        return;
    }
    if (!reenteredPassword) {
        showMessage('Please re-enter new password.', 'red');
        return;
    }

    if (newPassword !== reenteredPassword) {
        showMessage('New passwords do not match. Please re-enter.', 'red');
        return;
    }

    const userData = await fetchDataFromDropbox('/user-accounts.txt');
    const userIndex = userData.findIndex(user => user.Email === email);

    if (userIndex === -1) {
        return showMessage('User data not found. Please try again.', 'red');
    }

    userData[userIndex].Password = newPassword;
    
    // Update loginStatus to '0' for the user
    userData[userIndex].LoginStatus = '0';

    // Update user's password and loginStatus in the Dropbox data
    const updateResponse = await fetch('https://content.dropboxapi.com/2/files/upload', {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + dropboxToken,
            'Content-Type': 'application/octet-stream',
            'Dropbox-API-Arg': JSON.stringify({
                path: '/user-accounts.txt',
                mode: 'overwrite'
            })
        },
        body: JSON.stringify(userData)
    });
clearFormFields();

    document.getElementById('forgetPasswordDiv').style.display = 'none';
    document.getElementById('loginDiv').style.display = 'block';
    document.title = "Log in Your Account";
    showMessage('Password reset successfully! Now log in your account.', 'green');
}
function generateToken(refreshToken, clientId, clientSecret) {
const url = 'https://api.dropbox.com/oauth2/token';
const data = `grant_type=refresh_token&refresh_token=${refreshToken}&client_id=${clientId}&client_secret=${clientSecret}`;
return fetch(url, {
method: 'POST',
headers: {
'Content-Type': 'application/x-www-form-urlencoded'
},
body: data
})
.then((response) => {
if (!response.ok) {
throw new Error('Failed to get access token: ' + response.statusText);
}
return response.json();
})
.then((responseData) => {
return responseData.access_token;
})
.catch((error) => {
throw new Error('Error generating access token: ' + error.message);
});
}
function checkToken() {
    let localToken = JSON.parse(localStorage.getItem("localToken"));
    if (localToken && localToken.expire > new Date().getTime()) {
        dropboxToken = localToken.token;
        // Call the page load function here as token is valid
        pageLoad();
    } else {
        generateToken('AALu1gsBgjcAAAAAAAAAATLeuJoxd86bwIAnmd9KoDsWC4lRU_SruT9ZUVrfr8hz', '7u6mvcyvv6szugw', 'gka5o3baeaw2lin')
            .then((token) => {
                dropboxToken = token;
                var storeToken = { token: token, expire: new Date().getTime() + (3*60*60*1000)};
                localStorage.setItem("localToken", JSON.stringify(storeToken));
                // Call the page load function after generating token
                pageLoad();
            })
            .catch((error) => {
                showMessage(error.message, 'red');
            });
    }
}


function validateAndSubmit() {
showMessage('Creating account, please wait...', 'green');
createAccount();
}
        function changePassword2() {
                document.getElementById('loginDiv').style.display = 'none';
                document.getElementById('homeDiv').style.display = 'none';
                document.getElementById('changePasswordDiv').style.display = 'block';
                document.getElementById('mainDiv').style.display = 'block';
document.title = "Change Your Account Password";
    const userEmail = JSON.parse(localStorage.getItem('user')).Email;
    document.getElementById('div3').innerHTML = `Change Your Account Password. <br> Your Registered Email: ${userEmail}`;

        }
        // Function to handle user logout
function logout() {
    const user = JSON.parse(localStorage.getItem('user'));
    if (user) {
        // Fetch user data from Dropbox
        fetchDataFromDropbox('/user-accounts.txt').then(userData => {
            const userIndex = userData.findIndex(u => u.Email === user.Email && u.Password === user.Password);
            if (userIndex !== -1) {
                // Update loginStatus to '0' in user data
                userData[userIndex].LoginStatus = '0';
                // Update user data in Dropbox
                updateUserDataInDropbox(userData).then(() => {
                    localStorage.removeItem('user'); // Clear user data from localStorage
                    document.getElementById('mainDiv').style.display = 'block';
                    document.getElementById('homeDiv').style.display = 'none';
                    document.title = "Log in Your Account";
                    showMessage('Logged out successfully.', 'green');
                }).catch(error => {
                    showMessage('An error occurred while logging out. Please try again.', 'red');
                    console.error('Logout Error:', error);
                });
            } else {
                showMessage('User not found. Unable to logout.', 'red');
            }
        }).catch(error => {
            showMessage('An error occurred while logging out. Please try again.', 'red');
            console.error('Logout Error:', error);
        });
    } else {
        showMessage('No user is currently logged in.', 'red');
    }
}

// Function to update user data in Dropbox
async function updateUserDataInDropbox(userData) {
    const updatedResponse = await fetch('https://content.dropboxapi.com/2/files/upload', {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + dropboxToken,
            'Content-Type': 'application/octet-stream',
            'Dropbox-API-Arg': JSON.stringify({
                path: '/user-accounts.txt',
                'mode': 'overwrite',
                autorename: false,
                mute: false
            })
        },
        body: JSON.stringify(userData)
    });
    return updatedResponse;
}

// Check user login session on page load
function pageLoad() {
    document.title = "Loading in progress. Please wait.";
    showMessage('Loading in progress... Please wait.', 'blue');

    const user = JSON.parse(localStorage.getItem('user'));

    if (user) {
        try {
            let userData = await fetchDataFromDropbox('/user-accounts.txt');
            const userIndex = userData.findIndex(u => u.Email === user.Email);

            if (userIndex !== -1) {
                if (userData[userIndex].Password === user.Password) {
                    document.getElementById('mainDiv').style.display = 'none';
                    document.getElementById('homeDiv').style.display = 'block';
                    document.title = "Saint Joseph's Academy";
                    showMessage(`Welcome back, ${user.FirstName} ${user.LastName}!`, 'green');
                } else {
                    localStorage.removeItem('user');
                    document.getElementById('mainDiv').style.display = 'block';
                    document.getElementById('homeDiv').style.display = 'none';
                    document.title = "You have been logged out due to a change of password.";
                    showMessage('You have been logged out due to a change of password.', 'red');
                }
            } else {
                localStorage.removeItem('user');
                document.getElementById('mainDiv').style.display = 'block';
                document.getElementById('homeDiv').style.display = 'none';
                document.title = "User data not found. Please log in.";
                showMessage('User data not found. Please log in.', 'red');
            }
        } catch (error) {
            console.error('Error while fetching user data:', error);
            showMessage(`An error occurred while fetching user data: ${error}`, 'red');
        }
    } else {
        document.getElementById('mainDiv').style.display = 'block';
        document.getElementById('homeDiv').style.display = 'none';
        document.title = "Saint Joseph's Academy";
document.getElementById('alertBox').style.display = 'none';
    }
}
// Common function to fetch data from Dropbox
async function fetchDataFromDropbox(path) {
    const response = await fetch('https://content.dropboxapi.com/2/files/download', {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + dropboxToken,
            'Dropbox-API-Arg': JSON.stringify({
                path: path
            })
        }
    });
    return await response.json();
}

window.addEventListener("load", checkToken);
    </script>
<script>
function showDropdown(elementId) {
const element = document.getElementById(elementId);
const   event = document.createEvent('MouseEvents');
  event.initMouseEvent('mousedown', true, true, window);
  element.dispatchEvent(event);
}
var open1 = document.getElementById("target1");
function dropDown1() {
 if (open1.selectedIndex == 1) {
window.location.href="go:form";
reSet();
}  else     if (open1.selectedIndex == 2) {
 showDropdown('target2');
reSet();
} else     if (open1.selectedIndex == 3) {
 showDropdown('target3');
reSet();
} else     if (open1.selectedIndex == 4) {
window.location.href="http://action_share";
reSet();
} else     if (open1.selectedIndex == 5) {
changePasswordClick();
reSet();
} else     if (open1.selectedIndex == 6) {
logoutClick();
reSet();
 
} else     if (open1.selectedIndex == 7) {
window.location.href="go:admin";
reSet();
} 
}
 var open2 = document.getElementById("target2");
function dropDown2() {
    if (open2.selectedIndex == 1) {
window.location.href="go:mailus";
reSet();}
else     if (open2.selectedIndex == 2) {
window.location.href="whatsapp://send?text=Hello&phone=919693939396";
reSet();}
else     if (open2.selectedIndex == 3) {
window.location.href="tel:9693939396";
reSet();
}
} 
var open3 = document.getElementById("target3");
function dropDown3() {
    if (open3.selectedIndex == 1) {
window.location.href="tg://resolve?domain=SaintJosephsAcademyOfficial";
reSet();}
else     if (open3.selectedIndex == 2) {
window.location.href="https://whatsapp.com/channel/0029Va9kzfx8F2p7e8yzIV1t";
reSet();
}
}
    function reSet() {
var rst1 = document.getElementById("target1");  
var rst2 = document.getElementById("target2");
var rst3 = document.getElementById("target3");
rst1.selectedIndex = 0;
rst2.selectedIndex = 0;
rst3.selectedIndex = 0;
}
function changePasswordClick() {   
showMessage('Please wait...', 'blue');
setTimeout(function(){
changePassword2();
}, 2000);
}
function logoutClick() {   
showMessage('Logging out, please wait...', 'blue');
setTimeout(function(){
logout();
}, 1000);
}
</script>
</body>
</html>
