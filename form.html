<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Authentication</title>
</head>
<body>
    <div id="mainDiv">
        <div id="loginDiv" style="display: block;">
            <h2>Login</h2>
            <form id="signInForm">
                <label for="loginEmail">Email Address:</label>
                <input type="email" id="loginEmail">

                <label for="loginPassword">Password:</label>
                <input type="password" id="loginPassword">

                <button type="submit" onclick="login()">Login</button>
            </form>
            <button onclick="toggleForms('login')">Don't have an account? Sign Up</button>
        </div>

        <div id="createAccountDiv" style="display: none;">
            <h2>Create an Account</h2>
            <form id="signUpForm">
                <label for="firstName">First Name:</label>
                <input type="text" id="firstName">

                <label for="lastName">Last Name:</label>
                <input type="text" id="lastName">

                <label for="gender">Gender:</label>
                <select id="gender">
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                </select>

                <label for="email">Email Address:</label>
                <input type="email" id="email">

                <label for="password">Password:</label>
                <input type="password" id="password">

                <label for="rePassword">Re-enter Password:</label>
                <input type="password" id="rePassword">

                <label>
                    <input type="checkbox" id="showPasswordCheckbox">
                    Show Password
                </label>

                <button type="submit" onclick="checkEmailAvailability()">Create Account</button>
            </form>
            <button onclick="toggleForms('create')">Have an account? Sign In</button>
        </div>
            <p id="validationError" aria-live="assertive" aria-atomic="true" role="alert" style="color: red; display: none;"></p>
    </div>

    <script>
        function toggleForms(formType) {
            const loginDiv = document.getElementById('loginDiv');
            const createAccountDiv = document.getElementById('createAccountDiv');

            if (formType === 'login') {
                loginDiv.style.display = 'none';
                createAccountDiv.style.display = 'block';
            } else if (formType === 'create') {
                loginDiv.style.display = 'block';
                createAccountDiv.style.display = 'none';
            }
        }

function clearFormFields() {
document.getElementById('signInForm').reset();
document.getElementById('signUpForm').reset();
}
        function showMessage(message, color) {
            const validationError = document.getElementById('validationError');
            validationError.innerText = message;
            validationError.style.color = color;
            validationError.style.display = 'block';
        }
        async function login() {
            const loginEmail = document.getElementById('loginEmail').value;
            const loginPassword = document.getElementById('loginPassword').value;

            // Fetch user data from Dropbox
            const response = await fetch('https://content.dropboxapi.com/2/files/download', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + dropboxToken,
                    'Dropbox-API-Arg': JSON.stringify({
                        path: '/user-accounts.txt'
                    })
                }
            });
            const userData = await response.json();

            const user = userData.find(user => user.Email === loginEmail && user.Password === loginPassword);

            if (user) {
                showMessage(Login successful! Welcome, ${user.FirstName} ${user.LastName}!, 'green');
            } else {
                showMessage('Invalid email or password. Please try again.', 'red');
            }
        }
        async function checkEmailAvailability() {
            const email = document.getElementById('email').value;

            // Fetch user data from Dropbox
            const response = await fetch('https://content.dropboxapi.com/2/files/download', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + dropboxToken,
                    'Dropbox-API-Arg': JSON.stringify({
                        path: '/user-accounts.txt'
                    })
                }
            });
            const userData = await response.json();

            const emailExists = userData.some(user => user.Email === email);

            if (emailExists) {
                showMessage('Your account is already created. Please login with your email address and password.', 'blue');
            } else {
                validateAndSubmit();
            }
        }

        async function createAccount() {
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const gender = document.getElementById('gender').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const rePassword = document.getElementById('rePassword').value;

            if (password !== rePassword) {
                showMessage('Passwords dont match. Please re-enter.', 'red');
return;
            }

            // Fetch existing user data from Dropbox
            const response = await fetch('https://content.dropboxapi.com/2/files/download', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + dropboxToken,
                    'Dropbox-API-Arg': JSON.stringify({
                        path: '/user-accounts.txt'
                    })
                }
            });
            let userData = await response.json();

            // Add new user data
            userData.push({
                FirstName: firstName,
                LastName: lastName,
                Gender: gender,
                Email: email,
                Password: password
            });

            // Save updated user data to Dropbox
            const updatedResponse = await fetch('https://content.dropboxapi.com/2/files/upload', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + dropboxToken,
                    'Content-Type': 'application/octet-stream',
                    'Dropbox-API-Arg': JSON.stringify({
                        path: '/user-accounts.txt',
                        'mode': 'overwrite',
                        autorename: false,
                        mute: false
                    })
                },
                body: JSON.stringify(userData)
            });

            showMessage('Account created successfully!', 'green');
        }
function generateToken(refreshToken, clientId, clientSecret) {
const url = 'https://api.dropbox.com/oauth2/token';
const data = `grant_type=refresh_token&refresh_token=${refreshToken}&client_id=${clientId}&client_secret=${clientSecret}`;
return fetch(url, {
method: 'POST',
headers: {
'Content-Type': 'application/x-www-form-urlencoded'
},
body: data
})
.then((response) => {
if (!response.ok) {
throw new Error('Failed to get access token: ' + response.statusText);
}
return response.json();
})
.then((responseData) => {
return responseData.access_token;
})
.catch((error) => {
throw new Error('Error generating access token: ' + error.message);
});
}
function checkToken() {
let localToken = JSON.parse(localStorage.getItem("localToken"));
if (localToken && localToken.expire > new Date().getTime()) {
dropboxToken = localToken.token;
} else {
generateToken('AALu1gsBgjcAAAAAAAAAATLeuJoxd86bwIAnmd9KoDsWC4lRU_SruT9ZUVrfr8hz', '7u6mvcyvv6szugw', 'gka5o3baeaw2lin')
.then((token) => {
dropboxToken = token;
var storeToken = { token: token, expire: new Date().getTime() + (3*60*60*1000)};
localStorage.setItem("localToken", JSON.stringify(storeToken));
})
.catch((error) => {
showMessage(error.message, 'red');
});
}
}
function validateAndSubmit() {
showMessage('Creating account, please wait...', 'green');
createAccount();
}

window.addEventListener("load", checkToken);
    </script>
</body>
</html>